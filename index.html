<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Anonymous Messages</title>

<!-- Firebase (Compat) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- React -->
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=DM+Sans:wght@400;500;700&family=Playfair+Display:wght@700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="css/styles.css">
</head>

<body>
<div id="root"></div>

<!-- Firebase Init -->
<script>
const firebaseConfig = {
  apiKey: "AIzaSyANnSK6RB-E5fv0FGxHyysyCIna1sPVHXA",
  authDomain: "anonymousdb-ba963.firebaseapp.com",
  projectId: "anonymousdb-ba963",
  storageBucket: "anonymousdb-ba963.firebasestorage.app",
  messagingSenderId: "525026837730",
  appId: "1:525026837730:web:f30c5c929ac6f7a2528abb"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();
</script>

<script type="text/babel">
const { useState, useEffect } = React;

function FloatingWords({ enabled = true, word = "ANONYMOUS" }) {
  const [items, setItems] = useState([]);

  useEffect(() => {
    if (!enabled) return;

    const rand = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

    const makeOne = () => {
      const id = (crypto?.randomUUID ? crypto.randomUUID() : String(Date.now() + Math.random()));
      const left = Math.random() * 100;
      const top = Math.random() * 100;

      const style = {
        left: `${left}%`,
        top: `${top}%`,
        fontSize: `${rand(10, 18)}px`,
        "--dur": `${rand(4, 8)}s`,
        "--xStart": `${rand(-40, 40)}px`,
        "--yStart": `${rand(-40, 40)}px`,
        "--xMid": `${rand(-120, 120)}px`,
        "--yMid": `${rand(-120, 120)}px`,
        "--xEnd": `${rand(-220, 220)}px`,
        "--yEnd": `${rand(-220, 220)}px`,
      };

      setItems(prev => [{ id, text: word, style }, ...prev].slice(0, 25));

      setTimeout(() => {
        setItems(prev => prev.filter(x => x.id !== id));
      }, 9000);
    };

    const interval = setInterval(makeOne, 900);
    for (let i = 0; i < 6; i++) setTimeout(makeOne, i * 180);

    return () => clearInterval(interval);
  }, [enabled, word]);

  return (
    <div className="floating-words">
      {items.map(it => (
        <span key={it.id} className="floating-word" style={it.style}>
          {it.text}
        </span>
      ))}
    </div>
  );
}

function App() {
  const [message, setMessage] = useState('');
  const [messages, setMessages] = useState([]);
  const [showSuccess, setShowSuccess] = useState(false);
  const [isAdmin, setIsAdmin] = useState(false);
  const [adminUser, setAdminUser] = useState(null);
  const [loadingMessages, setLoadingMessages] = useState(false);
  const [isLoading, setIsLoading] = useState(false);

  // --- Admin auth + load messages ---
  useEffect(() => {
    const adminMode = window.location.hash === '#admin';
    if (!adminMode) return;

    setIsAdmin(true);

    const unsubAuth = auth.onAuthStateChanged((user) => {
      setAdminUser(user || null);

      if (!user) {
        const email = prompt("Admin email:");
        const password = prompt("Admin password:");

        if (!email || !password) {
          alert("Login cancelled. Going back to form.");
          window.location.hash = "";
          setIsAdmin(false);
          return;
        }

        auth.signInWithEmailAndPassword(email, password)
          .catch((err) => {
            alert("Login failed: " + err.message);
            window.location.hash = "";
            setIsAdmin(false);
          });

        return;
      }

      setLoadingMessages(true);

      const unsubSnap = db.collection("messages")
        .orderBy("timestamp", "desc")
        .onSnapshot(
          (snapshot) => {
            const msgs = snapshot.docs.map(doc => ({
              id: doc.id,
              ...doc.data()
            }));
            setMessages(msgs);
            setLoadingMessages(false);
          },
          (error) => {
            setLoadingMessages(false);
            alert("Cannot read messages: " + error.message);
          }
        );

      return () => unsubSnap();
    });

    return () => unsubAuth();
  }, []);

  // --- Send message (public) ---
  const handleSubmit = async (e) => {
    e.preventDefault();
    if (message.trim().length === 0) return;

    try {
      setIsLoading(true);

      await db.collection("messages").add({
        text: message,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });

      setMessage('');
      setShowSuccess(true);
      setTimeout(() => setShowSuccess(false), 3000);
    } catch (err) {
      alert("Failed to send: " + err.message);
    } finally {
      setIsLoading(false);
    }
  };

  const handleAdminLogout = async () => {
    try {
      await auth.signOut();
      window.location.hash = "";
      setIsAdmin(false);
      setMessages([]);
    } catch (e) {
      alert("Logout error: " + e.message);
    }
  };

  const formatDate = (timestamp) => {
    if (!timestamp) return '';
    try {
      const date = timestamp.toDate();
      return date.toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    } catch {
      return '';
    }
  };

  // --- ADMIN VIEW ---
  if (isAdmin) {
    return (
      <div className="container">
        <FloatingWords enabled={true} word="ANONYMOUS" />

        <div className="admin-view">
          <div className="admin-header" style={{display:"flex",justifyContent:"space-between",alignItems:"center",gap:"12px"}}>
            <div>
              <h2>Received Messages</h2>
              <div className="message-count">
                {loadingMessages ? "Loading..." : `${messages.length} ${messages.length === 1 ? 'message' : 'messages'}`}
              </div>
            </div>

            {adminUser && (
              <button className="btn" onClick={handleAdminLogout} style={{width:"auto"}}>
                Logout
              </button>
            )}
          </div>

          {loadingMessages ? (
            <div className="no-messages">
              <div className="no-messages-icon">‚è≥</div>
              <p>Loading messages...</p>
            </div>
          ) : messages.length === 0 ? (
            <div className="no-messages">
              <div className="no-messages-icon">üì≠</div>
              <p>No messages yet. Share your link to start receiving anonymous messages!</p>
            </div>
          ) : (
            messages.map((msg, index) => (
              <div
                key={msg.id}
                className="message-item"
                style={{ animationDelay: `${index * 0.1}s` }}
              >
                <div className="message-text">{msg.text}</div>
                <div className="message-meta" style={{display:"flex",justifyContent:"space-between",gap:"10px"}}>
                  <span>Anonymous</span>
                  <span>{formatDate(msg.timestamp)}</span>
                </div>
              </div>
            ))
          )}
        </div>

        <div className="footer">
          <p>
            Want to receive messages?
            <a href="#" style={{ color: 'var(--accent)', marginLeft: '8px' }}>
              Go back to form
            </a>
          </p>
        </div>
      </div>
    );
  }

  // --- PUBLIC VIEW ---
  return (
    <div className="container">
      <FloatingWords enabled={true} word="ANONYMOUS" />

      <div className="hero">
        <div className="logo">üîí</div>
        <div>
          <h1 className="neon-title">Tisakwiye Anonymous</h1>
          <p className="subtitle">
            Share your thoughts freely.
          </p>
        </div>
      </div>

      <div className="card">
        <form onSubmit={handleSubmit}>
          <div className="form-group">
            <label htmlFor="message">Your Anonymous Message</label>
            <textarea
              id="message"
              value={message}
              onChange={(e) => setMessage(e.target.value)}
              placeholder="Type your message here...."
              maxLength={1000}
            />
            <div className="char-count">
              {message.length} / 1000
            </div>
          </div>

          <button
            type="submit"
            className={`btn ${isLoading ? 'loading' : ''}`}
            disabled={message.trim().length === 0 || isLoading}
          >
            <span>{isLoading ? 'Sending...' : 'Send Message'}</span>
          </button>
        </form>

        {showSuccess && (
          <div className="success-message">
            <h3>‚úì Message Sent!</h3>
            <p>Your anonymous message has been delivered successfully.</p>
          </div>
        )}
      </div>

      <div className="footer">
        <p>
          <span className="footer-icon">‚Ä¢</span>
          @skenzo Mitriingle <span className="footer-icon">‚Ä¢</span>
        </p>
      </div>
    </div>
  );
}

ReactDOM.render(<App />, document.getElementById('root'));
</script>

</body>
</html>
